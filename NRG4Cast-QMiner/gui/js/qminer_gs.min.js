// TODO query examples
////////////////////////////////////////////////////////////////////
var Qm={};Qm.StoresData=null,Qm.CurrentStore=null,Qm.CurrentStoreData=null,Qm.QuickInfo=null,Qm.DemoData={Stores:{stores:[{storeId:12,storeName:"Visit1",storeRecords:0,fields:[{fieldId:0,fieldName:"Cookie",valueType:"STRING",featureType:"NONE",aggregationType:"NONE",displayType:"NONE",keys:[{keyId:0},{keyId:1},{keyId:2}],is_small_string:!0,location:"c",use_as_name:!1,use_codebook:!1},{fieldId:1,fieldName:"URL",valueType:"STRING",featureType:"NONE",aggregationType:"NONE",displayType:"TEXT",is_small_string:!1,location:"c",use_as_name:!1,use_codebook:!1},{fieldId:2,fieldName:"ServerTime",valueType:"DATE-TIME",featureType:"DATE-TIME",aggregationType:"NONE",displayType:"TEXT",is_small_string:!1,location:"c",use_as_name:!1,use_codebook:!1}],keys:[{keyId:0,keyName:"Cookie",keyText:!1,aggregation:!1,wordVoc:{wordVocId:0,values:0},fields:[{fieldId:0}]},{keyId:1,keyName:"URL",keyText:!1,aggregation:!1,wordVoc:{wordVocId:0,values:0},fields:[{fieldId:0}]},{keyId:2,keyName:"ServerTime",keyText:!1,aggregation:!1,wordVoc:{wordVocId:0,values:0},fields:[{fieldId:0}]}],joins:[],time_window_source_field:"",time_window_source_field_id:0,sys_inserted_at_field:"_sys_inserted_at",window_size:1,window_type:1},{storeId:32,storeName:"Visit2",storeRecords:0,fields:[{fieldId:0,fieldName:"Cookie",valueType:"STRING",featureType:"NONE",aggregationType:"NONE",displayType:"NONE",keys:[{keyId:3},{keyId:4},{keyId:5}],is_small_string:!0,location:"c",use_as_name:!1,use_codebook:!1},{fieldId:1,fieldName:"URL",valueType:"STRING",featureType:"NONE",aggregationType:"NONE",displayType:"TEXT",is_small_string:!1,location:"c",use_as_name:!1,use_codebook:!1},{fieldId:2,fieldName:"ServerTime",valueType:"DATE-TIME",featureType:"DATE-TIME",aggregationType:"NONE",displayType:"TEXT",is_small_string:!1,location:"c",use_as_name:!1,use_codebook:!1}],keys:[{keyId:3,keyName:"Cookie",keyText:!1,aggregation:!1,wordVoc:{wordVocId:0,values:0},fields:[{fieldId:0}]},{keyId:4,keyName:"URL",keyText:!1,aggregation:!1,wordVoc:{wordVocId:0,values:0},fields:[{fieldId:0}]},{keyId:5,keyName:"ServerTime",keyText:!1,aggregation:!1,wordVoc:{wordVocId:0,values:0},fields:[{fieldId:0}]}],joins:[],time_window_source_field:"ServerTime",time_window_source_field_id:2,sys_inserted_at_field:"_sys_inserted_at",window_size:144e4,window_type:2},{storeId:43,storeName:"Visit3",storeRecords:0,fields:[{fieldId:0,fieldName:"Cookie",valueType:"STRING",featureType:"NONE",aggregationType:"NONE",displayType:"NONE",keys:[{keyId:6},{keyId:7},{keyId:8}],is_small_string:!0,location:"c",use_as_name:!1,use_codebook:!1},{fieldId:1,fieldName:"URL",valueType:"STRING",featureType:"NONE",aggregationType:"NONE",displayType:"TEXT",is_small_string:!1,location:"c",use_as_name:!1,use_codebook:!1},{fieldId:2,fieldName:"ServerTime",valueType:"DATE-TIME",featureType:"DATE-TIME",aggregationType:"NONE",displayType:"TEXT",is_small_string:!1,location:"c",use_as_name:!1,use_codebook:!1},{fieldId:3,fieldName:"_sys_inserted_at",valueType:"DATE-TIME",featureType:"NONE",aggregationType:"NONE",displayType:"NONE",is_small_string:!1,location:"c",use_as_name:!1,use_codebook:!1}],keys:[{keyId:6,keyName:"Cookie",keyText:!1,aggregation:!1,wordVoc:{wordVocId:0,values:0},fields:[{fieldId:0}]},{keyId:7,keyName:"URL",keyText:!1,aggregation:!1,wordVoc:{wordVocId:0,values:0},fields:[{fieldId:0}]},{keyId:8,keyName:"ServerTime",keyText:!1,aggregation:!1,wordVoc:{wordVocId:0,values:0},fields:[{fieldId:0}]}],joins:[],time_window_source_field:"_sys_inserted_at",time_window_source_field_id:3,sys_inserted_at_field:"_sys_inserted_at",window_size:1e3,window_type:2},{storeId:53,storeName:"VisitAll",storeRecords:0,fields:[{fieldId:0,fieldName:"Cookie",valueType:"STRING",featureType:"NONE",aggregationType:"NONE",displayType:"NONE",keys:[{keyId:9},{keyId:10},{keyId:11}],is_small_string:!0,location:"c",use_as_name:!1,use_codebook:!1},{fieldId:1,fieldName:"URL",valueType:"STRING",featureType:"NONE",aggregationType:"NONE",displayType:"TEXT",is_small_string:!1,location:"c",use_as_name:!1,use_codebook:!1},{fieldId:2,fieldName:"ServerTime",valueType:"DATE-TIME",featureType:"DATE-TIME",aggregationType:"NONE",displayType:"TEXT",is_small_string:!1,location:"c",use_as_name:!1,use_codebook:!1}],keys:[{keyId:9,keyName:"Cookie",keyText:!1,aggregation:!1,wordVoc:{wordVocId:0,values:0},fields:[{fieldId:0}]},{keyId:10,keyName:"URL",keyText:!1,aggregation:!1,wordVoc:{wordVocId:0,values:0},fields:[{fieldId:0}]},{keyId:11,keyName:"ServerTime",keyText:!1,aggregation:!1,wordVoc:{wordVocId:0,values:0},fields:[{fieldId:0}]}],joins:[],time_window_source_field:"",time_window_source_field_id:0,sys_inserted_at_field:"_sys_inserted_at",window_size:0,window_type:0}],index_path:"../../output/data/"},QuickInfo:{stores:4,records:0,store_with_max_records:{name:"",records:0}}},Qm.Utils={},Qm.Main={},Qm.Admin={},Qm.StoreList={},Qm.Main.GarbageCollect=function(){$("#btnGc").hide(),$("#spanGcStatus").show(),$.getJSON("/gs_gc",function(e){$("#spanGcSuccess").show(),$("#spanGcStatus").hide(),setTimeout(function(){$("#btnGc").show(),$("#spanGcSuccess").hide()},1500)})},Qm.Main.ShowQuickInfo=function(){Qm.QuickInfo==null?$.getJSON("/gs_quick_info",function(e){Qm.QuickInfo=e,Qm.Main.ShowQuickInfoCallback()}):Qm.Main.ShowQuickInfoCallback()},Qm.Main.ShowQuickInfoCallback=function(){$("#spanQiStores").text(Qm.QuickInfo.stores),$("#spanQiRecords").text(Qm.QuickInfo.records),$("#spanQiMaxRecStore").text(Qm.QuickInfo.store_with_max_records.name),$("#spanQiMaxRecStoreCnt").text(Qm.QuickInfo.store_with_max_records.records)},Qm.ClearData=function(){Qm.StoresData=null,Qm.CurrentStore=null,Qm.CurrentStoreData=null,Qm.QuickInfo=null},Qm.StoreList.DrawStoreList=function(){Qm.StoresData==null?$.getJSON("/gs_store_def",function(e){Qm.StoresData=e,Qm.StoreList.DrawStoreListInner()}):Qm.StoreList.DrawStoreListInner()},Qm.StoreList.DrawStoreListInner=function(){var e=$("#ulStoreList");if(Qm.StoresData.stores.length==0)$("#divStoreList").text("No store defined");else{for(var t=0;t<Qm.StoresData.stores.length;t++){var n=Qm.StoresData.stores[t];for(var r=0;r<n.fields.length;r++)n.fields[r].is_in_cache=n.fields[r].location=="c",n.fields[r].location_str=n.fields[r].location=="c"?"cache":"memory";for(var r=0;r<n.joins.length;r++)n.joins[r].is_index=n.joins[r].joinType=="index";for(var r=0;r<n.keys.length;r++){var i=n.keys[r],s=[];for(var o=0;o<i.fields.length;o++){var u=Qm.Utils.GetFieldById(n,i.fields[o].fieldId).fieldName;i.fields[o].fieldName=u,s.push(u)}i.field_names=s.join(", ")}}var a=$("#tmplTableListItem").html(),f=Handlebars.compile(a);$("#divStoreList").html(f(Qm.StoresData))}},Qm.StoreList.DrawStoreInfo=function(e){Qm.CurrentStore=e,Qm.StoresData==null?$.getJSON("/stores",function(e){Qm.StoresData=e,Qm.StoreList.DrawStoreInfoInner()}):Qm.StoreList.DrawStoreInfoInner()},Qm.StoreList.DrawStoreInfoInner=function(){Qm.CurrentStoreData=null;for(var e=0;e<Qm.StoresData.stores.length;e++){var t=Qm.StoresData.stores[e];if(t.storeName==Qm.CurrentStore){Qm.CurrentStoreData=t;break}}if(Qm.CurrentStoreData==null){Qm.Utils.ShowError("Couldn't find store with name '"+Qm.CurrentStore+"'");return}$("#spanStoreName").text(t.storeName);var n="";if(t.window_type==0)n="No window for store data.";else if(t.window_type==1)n="<span class='icon'><i class='icon-resize-horizontal'></i></span> Simple length window for store data - length = "+t.window_size;else{var r=Qm.Utils.GetMsAsTimeStr(t.window_size);n="<span class='icon'><i class='icon-time'></i></span> Time-driven window length for store data - field = "+t.time_window_source_field+", size = "+r}$("#divWindowDesc").html(n);var i=$("#tmplIndex").html(),s=Handlebars.compile(i);$("#divIndexList").html(s(t)),i=$("#tmplJoin").html(),s=Handlebars.compile(i),$("#divJoinList").html(s(t)),i=$("#tmplField").html(),s=Handlebars.compile(i),$("#divFieldList").html(s(t)),$("#divMain").show()},Qm.Utils.GetFieldById=function(e,t){for(var n=0;n<e.fields.length;n++){var r=e.fields[n];if(r.fieldId==t)return r}return null},Qm.Utils.ShowError=function(e){$("#spanErrorText").text(e),$("#divError").show()},Qm.Utils.GetMsAsTimeStr=function(e){var t=""+e%1e3+" msec";return e=Math.round(e/1e3),e>0&&(t=""+e%60+" sec "+t,e=Math.round(e/60),e>0&&(t=""+e%60+" min "+t,e=Math.round(e/60),e>0&&(t=""+e%24+" h "+t,e=Math.round(e/24),e>0&&(t=""+e+" days "+t)))),t},Qm.Utils.IsEmptyStr=function(e){return e==null||e.trim()==""},Qm.Utils.IsInt=function(e,t){if(e.length==0)return!1;var n=parseInt(e);return n==NaN?!1:!t&&n<0?!1:!0},Qm.Utils.IsEmptyArray=function(e){return e.length==0},Qm.Admin.CreateField=function(){var self=this;self.name=ko.observable("Field"),self.primary=!1,self.type="string",self.featureType="none",self.aggregationType="none",self.displayType="none",self.store="cache",self.default_val=null,self.codebook=!1,self.shortstring=!0,self.CreateRequest=function(){var res={};return res.name=self.name(),res.primary=self.primary,res.type=self.type,res.featureType=self.featureType,res.aggregationType=self.aggregationType,res.displayType=self.displayType,res.store=self.store,res.codebook=self.codebook,res.shortstring=self.shortstring,self.default_val!=null&&self.default_val.trim()!=""&&eval("res.default_val = "+self.default_val),res}},Qm.Admin.CreateStore=function(){var self=this;self.id="",self.name=ko.observable("NewStore"),self.fields=ko.observableArray(),self.indexes=ko.observableArray(),self.joins=ko.observableArray(),self.window_type=ko.observable("None"),self.window_len=1e6,self.window_unit="hour",self.window_field="",self.field_names=ko.computed(function(){var e=[];return $.each(self.fields(),function(){e.push(this.name)}),e.sort(),e}),self.field_names2=ko.computed(function(){var e=["-"];return $.each(self.fields(),function(){e.push(this.name)}),e.sort(),e}),self.display_error_message=ko.observable(!1),self.errors=ko.observableArray(),self.error_msg=ko.observable(null),self.Validate=function(){self.errors.removeAll(),Qm.Utils.IsEmptyStr(self.name())&&self.errors.push("Missing store name"),!Qm.Utils.IsEmptyStr(self.id)&&!Qm.Utils.IsInt(self.id)&&self.errors.push("Store id not valid");var primary_field=null,fields_map={};$.each(self.fields(),function(){var field=this,fn=field.name();Qm.Utils.IsEmptyStr(fn)&&self.errors.push("Missing field name"),fields_map[fn]!=null?self.errors.push("Duplicate field name: "+fn):fields_map[fn]=!0,field.primary&&(primary_field!=null?self.errors.push("Multiple fields marked as primary."):primary_field=field.primary);if(field.default_val!=null&&field.default_val.trim()!="")try{eval("var xyz = "+field.default_val)}catch(e){self.errors.push("Invalid default value for field "+fn)}});var index_map={};$.each(self.indexes(),function(){var e=this;t=e.field;var t=e.name;Qm.Utils.IsEmptyStr(t)&&(t=e.field),index_map[t]!=null?self.errors.push("Duplicate index name: "+t):index_map[t]=!0});var joins_map={};return $.each(self.joins(),function(){var e=this;Qm.Utils.IsEmptyStr(e.name)&&self.errors.push("Missing join name"),joins_map[e.name]!=null?self.errors.push("Duplicate join name: "+e.name):joins_map[e.name]=!0}),primary_field==null&&self.errors.push("No primary field defined."),self.window_type=="Time"&&self.window_field!=""&&self.window_field!=null,self.display_error_message(self.errors().length>0),self.error_msg(self.errors().length>0?self.errors().join("<br/>"):null),!self.display_error_message()},self.AddField=function(){self.fields.push(new Qm.Admin.CreateField)},self.AddIndex=function(){self.indexes.push({field:"",name:"",type:"value",vocabulary:"",field_names:self.field_names})},self.AddJoin=function(){self.joins.push({name:"Join",type:"index",store:""})},self.CreateRequest=function(){var e={};return e.fields=[],e.joins=[],e.keys=[],e.name=self.name(),self.id!=""&&self.id!=null&&(e.id=self.id),self.window_type=="Fixed"?e.window=parseInt(self.window_len):self.window_type=="Time"&&(e.timeWindow={},e.timeWindow.duration=parseInt(self.window_len),e.timeWindow.unit=self.window_unit,self.window_field!=null&&self.window_field.trim()!=""&&self.window_field.trim()!="-"&&(e.timeWindow.field=self.window_field)),$.each(self.fields(),function(){e.fields.push(this.CreateRequest())}),$.each(self.indexes(),function(){var t={field:this.field,type:this.type};this.name!=""&&(t.name=this.name),this.vocabulary!=""&&(t.vocabulary=this.vocabulary),e.keys.push(t)}),$.each(self.joins(),function(){var t={name:this.name,type:this.type,store:this.store};e.joins.push(t)}),e},self.AddField()},Qm.Admin.CreateModel=function(){var e=this;e.types=["int","int_v","uint64","string","string_v","bool","float","float_v","float_pair","datetime"],e.join_types=["index","field"],e.index_types=["value","text"],e.display_types=["none","text","map"],e.feature_types=["none","numeric","multinom","token","spnum","datetime"],e.aggr_types=["none","histogram","pie_chart","timeline","keywords","scalar"],e.store_types=["memory","cache"],e.time_window_units=["hour","minute","second","day","month","week"],e.window_types=["None","Fixed","Time"],e.stores=ko.observableArray(),e.errors=ko.observableArray(),e.error_msg=ko.observable(""),e.has_errors=ko.observable(!1),e.validate_executed=ko.observable(!1),e.json_for_server=ko.observable(""),e.json_for_server_obj=null,e.show_json=ko.observable(!1),e.existing_schema=ko.observable(!1),e.disable_btn_view=ko.computed(function(){return e.has_errors()||!e.validate_executed()},e),e.show_btn_send=ko.computed(function(){return!e.existing_schema()&&!e.has_errors()&&e.validate_executed()},e),e.store_names=ko.computed(function(){var t=[];return $.each(e.stores(),function(){t.push(this.name())}),t.sort(),t}),e.AddStore=function(){e.stores.push(new Qm.Admin.CreateStore)},e.RemoveStore=function(t){e.stores.remove(t)},e.AddField=function(e){e.AddField()},e.RemoveField=function(t){$.each(e.stores(),function(){this.fields.remove(t)})},e.AddIndex=function(e){e.AddIndex()},e.RemoveIndex=function(t){$.each(e.stores(),function(){this.indexes.remove(t)})},e.AddJoin=function(e){e.AddJoin()},e.RemoveJoin=function(t){$.each(e.stores(),function(){this.joins.remove(t)})},e.save=function(){e.lastSavedJson(JSON.stringify(ko.toJS(e.stores),null,2))},e.Validate=function(){var t=!0,n={};return e.errors.removeAll(),$.each(e.stores(),function(){var r=this;t=t&&r.Validate(),n[r.name()]!=null?e.errors.push("Duplicate store name: "+r.name()):n[r.name()]=!0}),t=t&&e.errors().length==0,e.validate_executed(!0),e.has_errors(!t),e.error_msg(e.errors().length>0?e.errors().join("<br/>"):null),t},e.HideJson=function(){e.show_json(!1)},e.CreateRequest=function(){var t={};t.stores=[],$.each(e.stores(),function(){t.stores.push(this.CreateRequest())}),e.json_for_server_obj=t,e.json_for_server(JSON.stringify(t,undefined,4)),e.show_json(!0)},e.SendToServer=function(){e.Validate()&&(e.CreateRequest(),$.ajax({type:"POST",url:"/gs_create_schema",data:e.json_for_server(),success:function(t){t.error==null?(alert("Done."),document.location="stores.html"):(e.validate_executed(!0),e.has_errors(!0),e.error_msg(t.error.message+"<br/>"+t.location))},dataType:"text",processData:!1}))},$.getJSON("/gs_quick_info",function(t){e.existing_schema(t.stores>0)})},Qm.Admin.Model=new Qm.Admin.CreateModel;